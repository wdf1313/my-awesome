# 缓存策略

## 为什么使用缓存？

Web 应用中说的缓存一般是对网站中引用的**静态资源**进行缓存，比如 js/css/图片/视频这些资源。

使用缓存可以减少网络延迟和带宽消耗，对于前端开发者来说最重要的是可以大幅度**提高网页打开的速度**。

## 强缓存

强缓存让浏览器直接从缓存中获取资源，如果本地缓存未过期，浏览器会直接使用本地缓存，不会与服务器进行通信。

强缓存主要通过以下两个 HTTP 响应头字段控制：

1. Cache-Control：
   - max-age=秒数：资源在本地缓存的最大存活时间（单位：秒）。在这段时间内，浏览器不会去服务器请求，直接用本地缓存。
   - public：资源可以被所有用户和中间缓存服务器（如 CDN、代理）缓存。
   - private：资源只允许单个用户缓存，不能被共享缓存（如 CDN）缓存，常用于用户个性化内容。
   - no-cache：不直接使用缓存，每次都要向服务器验证资源是否有效（但本地还是会存一份缓存）。
   - immutable：资源在 max-age 期间不会改变，浏览器不会去服务器验证，适合静态资源。
2. Expires：指定资源的过期时间，在 HTTP 1.0 中使用。

:::tip 资源可以被所有缓存，且在一年内不会发生变化。

```http
Cache-Control: public, max-age=31536000, immutable
```

:::

在浏览器开发者工具的 Network 面板中，资源的 SIze 显示为 disk cache 或者 memory cache 表示资源命中强缓存。

## 协商缓存

协商缓存是指浏览器会在缓存的基础上，向服务器发送请求，询问资源是否已经改变。服务器返回一个响应，指示资源是否仍然有效。

如果资源没有改变，浏览器就会继续使用本地缓存；如果资源已经改变，服务器会返回最新的资源。

协商缓存主要通过以下两个 HTTP 响应头字段控制：

- `If-Modified-Since`：客户端将上次缓存时的 Last-Modified 值发送给服务器，服务器判断自上次缓存以来是否有更新。如果没有更新，返回 304 状态码，表示资源未修改。

- `If-None-Match`：客户端将之前的 ETag 值发送给服务器，服务器使用这个值判断资源是否被修改。如果没有修改，返回 304。

:::tip demo

```http
If-Modified-Since: Wed, 21 Oct 2025 07:28:00 GMT
If-None-Match: "5d8c72a5-12345"
```

如果资源未改变，服务器会返回：

```http
HTTP/1.1 304 Not Modified
```

:::

## 强缓存 VS 协商缓存

| 比较项       | 强缓存（Strong Cache）        | 协商缓存（Conditional Cache）   |
| ------------ | ----------------------------- | ------------------------------- |
| 是否发起请求 | ❌ 不发请求，直接用本地缓存   | ✅ 发起请求，询问资源是否有更新 |
| 响应状态码   | 无（直接本地命中）            | 304 Not Modified 或 200 OK      |
| 性能表现     | ✅ 最快，完全避免网络         | 一般，需要一次往返              |
| 精准性       | ❌ 可能资源变了但你还在用旧的 | ✅ 能确认资源是否有变动         |
| 适用场景     | 资源稳定不易变                | 资源变化不频繁但需要实时性      |

## 缓存策略 ‼️

| 资源类型        | 缓存策略                                  | 原因                                               |
| --------------- | ----------------------------------------- | -------------------------------------------------- |
| HTML 页面       | 协商缓存（no-cache + ETag/Last-Modified） | 保证页面内容更新及时                               |
| JS/CSS 文件     | 强缓存（immutable + max-age + 文件 hash） | 内容变动时文件名变，适合长期缓存                   |
| 图片/字体等资源 | 强缓存（immutable + max-age + 文件 hash） | 通常较大、更新少，强缓存能明显提升加载速度         |
| API 请求        | 视业务需求决定，一般用协商缓存或禁止缓存  | 数据变化频繁时不缓存，静态数据可考虑 ETag 协商缓存 |
